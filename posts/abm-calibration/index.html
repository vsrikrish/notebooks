<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-06-15">

<title>Notebooks - Agent-Based Model Calibration</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Notebooks</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About These Notes</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://viveks.me" rel="" target=""><i class="bi bi-house-fill" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/vsrikrish/notebooks" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml" rel="" target=""><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#relevant-reading" id="toc-relevant-reading" class="nav-link active" data-scroll-target="#relevant-reading">Relevant Reading</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Agent-Based Model Calibration</h1>
  <div class="quarto-categories">
    <div class="quarto-category">modeling</div>
    <div class="quarto-category">stats</div>
    <div class="quarto-category">uncertainty</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 15, 2023</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">June 15, 2023</p>
    </div>
  </div>
    
  </div>
  

</header>

<div class="page-columns page-full"><p>See <a href="../agent-based-modeling/">agent-based modeling</a> for broader context. ABMs are notoriously difficult to calibrate (modesty aside, I’ve written one of several papers on this <span class="citation" data-cites="Srikrishnan2021-na">(<a href="#ref-Srikrishnan2021-na" role="doc-biblioref">Srikrishnan &amp; Keller, 2021</a>)</span>, with apparently little impact on the cottage industry of ABM papers with weak or no calibration). There are some very sensible approaches to validation, namely pattern-based modeling, but a sound and consistent approach to calibration beyond just fiddling with parameters until you get something that looks like the data is still lacking. This is one (very good) reason why economists, and others who are serious about model-based inference, are skeptical of ABMs. Nevertheless, this type of generative social science model is incredibly appropriate for a lot of interesting problems<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, and so we should try to do better instead of writing it off.</p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;Mainly as an explorative model, though…it’s not clear to me how to have any confidence in these models for consolidative purposes.</p></li></div></div>
<div class="no-row-height column-margin column-container"><div id="ref-Srikrishnan2021-na" class="csl-entry" role="listitem">
Srikrishnan, V., &amp; Keller, K. (2021). <span class="nocase">Small increases in agent-based model complexity can result in large increases in required calibration data</span>. <em>Environmental Modelling &amp; Software</em>, <em>138</em>, 104978. <a href="https://doi.org/10.1016/j.envsoft.2021.104978">https://doi.org/10.1016/j.envsoft.2021.104978</a>
</div></div><p>There are a few fundamental problems:</p>
<ol type="1">
<li>Data is just one realization of a stochastic process, and these processes are particularly noisy for the types of problems we’d like to use ABMs for. Tweaking the model until you fit the data is likely to overfit, and may underestimate equi- and multi-finality. If these models are interesting, the odds are that they don’t have a unique “best estimate” of parameters, and that’s assuming no <a href="../model-discrepancy/">model discrepancy</a> and observational error/noise.</li>
<li>The complexity of a good ABM makes it difficult to write down the calibration likelihood cleanly.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></li>
<li>Highly disaggregated data is either difficult to obtain or shouldn’t be used for privacy reasons. So often all we have are highly aggregated or elicited data, like survey results. There is a strong trend towards using these to calibrate ABMs, but I suspect this data is actually quite weak in terms of information (and therefore should be thought of as akin to expert assessment rather than the type of observational data we typically use in environmental modeling).</li>
<li>If an ABM is stochastic (and good ones probably should be), you really would like to re-run the ABM multiple times for each parameter setting to obtain multiple trajectories due to the complexity of its dynamics, and then compare that distribution to the data. This can get computationally expensive as the complexity of the model increases, so some type of parallelized approach may be needed.</li>
</ol>
<div class="no-row-height column-margin column-container"><li id="fn2"><p><sup>2</sup>&nbsp;In principle, many ABMs can be written as Markovian models, but this is not always easy to do in practice.</p></li></div><div class="page-columns page-full"><p>There is some movement towards using machine-learning methods to fit non-parametric models to make projections, but I think that’s a mistake. One is that without structure, it’s wildly easy to overfit or end up with nonsense.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> The other is that there’s no reason to believe any of the processes are stationary, and therefore that a structure-less model fit on historical or current data could generalize into the future <span class="citation" data-cites="Oreskes1994-br">(<a href="#ref-Oreskes1994-br" role="doc-biblioref">Oreskes et al., 1994</a>)</span>.</p><div class="no-row-height column-margin column-container"><li id="fn3"><p><sup>3</sup>&nbsp;<a href="https://www.bu.edu/earth/profiles/ian-sue-wing/">Ian Sue Wing</a> once told me that what he loves about economists is that when they don’t know how to make sense of the data, they add structure. I think this 100% the right way to go about things, and as Andrew Gelman puts it <a href="https://statmodeling.stat.columbia.edu/2014/05/22/big-data-needs-big-model/">“Big Data Needs Big Model”</a>.</p></li><div id="ref-Oreskes1994-br" class="csl-entry" role="listitem">
Oreskes, N., Shrader-Frechette, K., &amp; Belitz, K. (1994). <span class="nocase">Verification, validation, and confirmation of numerical models in the earth sciences</span>. <em>Science</em>, <em>263</em>, 641–646. <a href="https://doi.org/10.1126/science.263.5147.641">https://doi.org/10.1126/science.263.5147.641</a>
</div></div></div>
<p>So what are some options?</p>
<ul>
<li><a href="https://sites.google.com/view/benslee/">Ben Lee</a> and I are thinking about particle filtering to compare distributions of data (such as surveys with error bars) to distributions of simulation outcomes. This is potentially nice because it’s parallelizable and allows us to incorporate discrepancy.</li>
<li><a href="https://www.stat.cmu.edu/~cshalizi/">Cosma Shalizi</a> has some interesting ideas about indirect inference and random feature matching, which is related to Approximate Bayesian approaches.</li>
</ul>
<section id="relevant-reading" class="level2">
<h2 class="anchored" data-anchor-id="relevant-reading">Relevant Reading</h2>
<ul>
<li>Ciampaglia, G. L. (2013). A framework for the calibration of social simulation models. arXiv [physics.soc-ph]. <a href="https://doi.org/10.1142/S0219525913500306" class="uri">https://doi.org/10.1142/S0219525913500306</a></li>
<li>Anzola, D. (2021). The Theory-Practice Gap in the Evaluation of Agent-Based Social Simulations. <em>Science in Context</em>, 34(3), 393–410. <a href="https://doi.org/10.1017/S0269889722000242" class="uri">https://doi.org/10.1017/S0269889722000242</a></li>
<li>Fabretti, A. (2013). On the problem of calibrating an agent based model for financial markets. <em>Journal of Economic Interaction and Coordination</em>, 8(2), 277–293. <a href="https://doi.org/10.1007/s11403-012-0096-3" class="uri">https://doi.org/10.1007/s11403-012-0096-3</a></li>
<li>Fabretti, A. (2018). Markov chain analysis in agent-based model calibration by classical and simulated minimum distance. <em>Knowledge and Information Systems</em>, 61(1), 259–276. <a href="https://doi.org/10.1007/s10115-018-1258-y" class="uri">https://doi.org/10.1007/s10115-018-1258-y</a></li>
<li>Fadikar, A., Higdon, D., Chen, J., Lewis, B., Venkatramanan, S., &amp; Marathe, M. (2017, December 2). Calibrating a stochastic agent based model using quantile-based emulation. <em>SIAM/ASA J. Uncertainty Quantification</em>. <a href="https://doi.org/10.1137/17M1161233" class="uri">https://doi.org/10.1137/17M1161233</a></li>
<li>Lamperti, F., Roventini, A., &amp; Sani, A. (2018). Agent-based model calibration using machine learning surrogates. <em>Journal of Economic Dynamics &amp; Control</em>, 90, 366–389. <a href="https://doi.org/10.1016/j.jedc.2018.03.011" class="uri">https://doi.org/10.1016/j.jedc.2018.03.011</a></li>
<li>Ngo, T. A., &amp; See, L. (2012). Calibration and validation of agent-based models of land cover change. In A. J. Heppenstall, A. T. Crooks, L. M. See, &amp; M. Batty (Eds.), <em>Agent-Based Models of Geographical Systems</em> (pp.&nbsp;181–197). Dordrecht: Springer Netherlands. <a href="https://doi.org/10.1007/978-90-481-8927-4_10" class="uri">https://doi.org/10.1007/978-90-481-8927-4_10</a></li>
<li>Srikrishnan, V., &amp; Keller, K. (2021). Small increases in agent-based model complexity can result in large increases in required calibration data. <em>Environmental Modelling &amp; Software</em>, 138, 104978. <a href="https://doi.org/10.1016/j.envsoft.2021.104978" class="uri">https://doi.org/10.1016/j.envsoft.2021.104978</a></li>
<li>Shalizi, C. R. (2021). A note on simulation-based inference by matching random features. arXiv [stat.ME]. Retrieved from <a href="http://arxiv.org/abs/2111.09220" class="uri">http://arxiv.org/abs/2111.09220</a></li>
<li>Shalizi, C. R., &amp; Moore, C. (2003). What Is a Macrostate? Subjective Observations and Objective Dynamics. arXiv [cond-mat.stat-mech]. Retrieved from <a href="http://arxiv.org/abs/cond-mat/0303625" class="uri">http://arxiv.org/abs/cond-mat/0303625</a></li>
<li>Banisch, S., Lima, R., &amp; Araújo, T. (2011, August 8). Agent based models and opinion dynamics as Markov chains. arXiv [nlin.AO]. Retrieved from <a href="http://arxiv.org/abs/1108.1716" class="uri">http://arxiv.org/abs/1108.1716</a></li>
<li>KhudaBukhsh, W. R., Auddy, A., Disser, Y., &amp; Koeppl, H. (2019). Approximate lumpability for Markovian agent-based models using local symmetries. <em>Journal of Applied Probability</em>, 56(3), 647–671. <a href="https://doi.org/10.1017/jpr.2019.44" class="uri">https://doi.org/10.1017/jpr.2019.44</a></li>
<li>Filatova, T. (2015). Empirical agent-based land market: Integrating adaptive economic behavior in urban land-use models. <em>Computers, Environment and Urban Systems</em>, 54, 397–413. <a href="https://doi.org/10/ggr7zw" class="uri">https://doi.org/10/ggr7zw</a></li>
<li>Lee, J.-S., &amp; Filatova, T. (2019). Dimension reduction of multivariate outputs of socio-environmental agent-based models. <em>Ecological Complexity</em>, 40, 100730. <a href="https://doi.org/10.1016/j.ecocom.2018.07.008" class="uri">https://doi.org/10.1016/j.ecocom.2018.07.008</a></li>
<li>Lee, J.-S., Filatova, T., Ligmann-Zielinska, A., Hassani-Mahmooei, B., Stonedahl, F., Lorscheid, I., et al.&nbsp;(2015). The complexities of agent-based modeling output analysis. <em>Journal of Artificial Societies and Social Simulation: JASSS</em>, 18(4), 4. <a href="https://doi.org/10.18564/jasss.2897" class="uri">https://doi.org/10.18564/jasss.2897</a></li>
<li>Taghikhah, F., Voinov, A., Filatova, T., &amp; Polhill, J. (2022). Machine-assisted agent-based modeling: Opening the black box. <em>Journal of Computational Science</em>, 64, 101854. <a href="https://doi.org/10.1016/j.jocs.2022.101854" class="uri">https://doi.org/10.1016/j.jocs.2022.101854</a></li>
<li>Kattwinkel, M., &amp; Reichert, P. (2017). Bayesian parameter inference for individual-based models using a particle Markov chain Monte Carlo method. <em>Environmental Modelling &amp; Software</em>, 87, 110–119. <a href="https://doi.org/10.1016/j.envsoft.2016.11.001" class="uri">https://doi.org/10.1016/j.envsoft.2016.11.001</a></li>
<li>Grazzini, J., Richiardi, M., &amp; Tsionas, E. (2017). Bayesian estimation of agent-based models. <em>Journal of Economic Dynamics &amp; Control</em>, 77, 22. <a href="https://doi.org/10.1016/j.jedc.2017.01.014" class="uri">https://doi.org/10.1016/j.jedc.2017.01.014</a></li>
</ul>



</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>